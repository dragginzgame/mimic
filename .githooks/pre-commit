#!/usr/bin/env bash
set -euo pipefail

echo "Running pre-commit checks (fmt, sort)..."

# Ensure required tools are available
if ! rustup component list | grep -q "rustfmt.*(installed)"; then
  echo "rustfmt is not installed. Install with: rustup component add rustfmt" >&2
  exit 1
fi

if ! command -v cargo-sort >/dev/null 2>&1; then
  echo "cargo-sort not found. Install with: cargo install cargo-sort" >&2
  exit 1
fi

if ! command -v cargo-sort-derives >/dev/null 2>&1; then
  echo "cargo-sort-derives not found. Install with: cargo install cargo-sort-derives" >&2
  exit 1
fi

# Auto-format before checks
cargo fmt --all

# Stage any formatting changes so they are included in the commit
if ! git diff --quiet; then
  echo "Formatting changed files; staging updates..."
  git add -A
fi

# Run checks
cargo fmt --all -- --check
cargo sort --check
cargo sort-derives --check

echo "Pre-commit checks passed."
