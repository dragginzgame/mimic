version: 1
project:
  name: mimic
  description: Core framework with codegen, tests, and utilities.
  language: rust
  edition: "2024"
  toolchain: "1.89.0"

workspace:
  root: "."
  packages:
    - "crates/mimic"
    - "crates/mimic_build"
    - "crates/mimic_common"
    - "crates/mimic_schema"
    - "crates/mimic_tests"

commands:
  check:
    run: "make check"
    description: "Fast type-check for all crates."
  test:
    run: "make test"
    description: "Run all unit/integration tests."
  build:
    run: "make build"
    description: "Release build for the workspace."
  clippy:
    run: "make clippy"
    description: "Lints with warnings denied."
  fmt:
    run: "make fmt"
    description: "Format source using rustfmt."
  fmt_check:
    run: "make fmt-check"
    description: "Verify formatting."
  security:
    run: "make security-check"
    description: "Tag immutability and security checks."
  version:
    run: "make version"
    description: "Show current version."
  tags:
    run: "make tags"
    description: "List version tags."
  release_patch:
    run: "make patch"
    description: "Bump patch version and tag."
  release_minor:
    run: "make minor"
    description: "Bump minor version and tag."
  release_major:
    run: "make major"
    description: "Bump major version and tag."
  release_publish:
    run: "make release"
    description: "Create and push release."

workflows:
  pre_commit:
    - fmt_check
    - clippy
    - check
    - test
  ci_fast:
    - check
    - clippy
  release:
    - security
    - release_publish

defaults:
  build_command: build
  test_command: test
  lint_command: clippy
  format_command: fmt

assistant:
  rules:
    - "Prefer '?' over 'unwrap()'; handle errors explicitly."
    - "Keep public APIs documented; co-locate small unit tests."
    - "Do not modify pushed release tags."
    - "Keep changes minimal and focused; avoid unrelated fixes."
    - "Style: space out comments — add a blank line before comment blocks and around multi-line comments for readability."
    - "Style: prefer an explicit 'return' before the final line of a function to make the result stand out — but only when it does not trigger clippy warnings; otherwise keep idiomatic tail-expression."
    - "Do not change clippy/rustfmt settings to satisfy stylistic preferences; keep code clippy-clean."
    - "Clippy: use inline format args, ie format!('{var}')"
    - "Docs: use rustdoc triple slash '/// ' with a space, placed directly above important structs/enums/traits; add one blank line before the doc block for readability."
    - "Naming: use 'metrics' not 'stats' for types, modules, and endpoints (e.g., 'MetricsReport', 'mimic_metrics', 'MetricsSelect')."
    - "Counters: use saturating_* for arithmetic on totals and avoid overflows; no wrapping arithmetic."
    - "Visibility: default to private; use 'pub(crate)' instead of 'pub' unless necessary for the public API."
    - "APIs: avoid panics in library code; return typed errors (thiserror) and map messages consistently."
    - "Borrowing: avoid unnecessary clones; prefer borrowing and iterator adapters over temporary Vecs where possible."
    - "Functions: keep functions small and focused (aim < ~50 lines); extract helpers for clarity."
    - "Docs: add rustdoc to all public items, with a brief example when practical."
    - "Tests: unit tests near code; deterministic tests only; prefer descriptive names that express behavior (e.g., 'deletes_index_entries_on_remove')."
    - "Perf: prefer pre-allocation with 'with_capacity' when sizes are known; minimize allocations in hot paths."
    - "Imports: group per-crate and nest items in a single line when practical, e.g., `use crate::{a, b, c};` and `use icu::{cdk, prelude::*};`."
    - "Policy: no backward-compatibility guarantees at this stage — prioritize removing deprecated code and avoiding compatibility shims to reduce technical debt."
    - "Codegen (mimic_build): generate as little code as possible; prefer delegating behavior to `mimic::interface::*`. Use schema context to produce schema-driven glue (endpoints, signatures, paths), not business logic."
  testing:
    integration_dir: "crates/mimic_tests"
    single_crate_example: "cargo test -p mimic <filter>"

paths:
  assets_dir: "assets"
  scripts_dir: "scripts"

ignore:
  - "target/"
  - ".git/"
  - ".idea/"
  - ".vscode/"
  - "**/*.lock"
